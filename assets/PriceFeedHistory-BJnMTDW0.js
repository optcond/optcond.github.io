import{u as D,j as e}from"./query-Df61bAsc.js";import{r as y}from"./react-uYZGv8Ap.js";import{s as S,C,B as T,A as F,a as P,c as k}from"./index-DTJI8Ixo.js";import{T as U,a as _,b as A,c as j}from"./tabs-Bz2Whg2B.js";import{e as B,f as M,d as $}from"./lucide-fc_sQejf.js";import{R as H,L as R,C as E,X as I,Y as O,T as q,a as K}from"./recharts-wdVATIY2.js";import"./supabase-CskpBK-R.js";const Y=60*60*1e3,G=5e3,Q=async({source:t,hours:r,limit:s})=>{const a=new Date(Date.now()-r*Y).toISOString(),{data:l,error:n}=await S.from("price_feeds").select("*").eq("source",t).gte("recorded_at",a).order("recorded_at",{ascending:!0}).limit(s??G);if(n)throw new Error(n.message);return l??[]},W=({source:t,hours:r,limit:s})=>{const a=D({queryKey:["price-feed-history",t,r,s],queryFn:()=>Q({source:t,hours:r,limit:s}),refetchInterval:6e5,staleTime:3e4,refetchOnWindowFocus:!0,retry:1}),{points:l,stats:n}=y.useMemo(()=>{var g;const i=((g=a.data)==null?void 0:g.map(x=>({timestamp:x.recorded_at,blockNumber:x.block_number,price:x.price})))??[];if(i.length===0)return{points:i,stats:{latestPrice:null,change:null,percentChange:null,high:null,low:null,latestBlockNumber:null,lastUpdated:null}};const d=i[0],c=i[i.length-1],h=i.map(x=>x.price),o=Math.max(...h),m=Math.min(...h),u=c.price-d.price,f=d.price!==0?u/d.price*100:null;return{points:i,stats:{latestPrice:c.price,change:u,percentChange:f,high:o,low:m,latestBlockNumber:c.blockNumber,lastUpdated:c.timestamp}}},[a.data]);return{...a,pricePoints:l,stats:n}},p=[{value:"musd-1d",label:"mUSD feed · 24H",source:"musd_usdc",hours:24,limit:300,heading:"mUSD / USDC 100k sell order (Last 24 Hours)",changeLabel:"24h Change",highLabel:"24h High",lowLabel:"24h Low",emptyMessage:"No price feed updates recorded in the last 24 hours."},{value:"musd-30d",label:"mUSD feed · 30D",source:"musd_usdc_4h",hours:24/4*30,limit:300,heading:"mUSD / USDC 100k sell order (Last 30 Days)",changeLabel:"30d Change",highLabel:"30d High",lowLabel:"30d Low",emptyMessage:"No price feed updates recorded in the last 30 days."},{value:"btc",label:"BTC feed · 24H",source:"btc_oracle",hours:24,limit:300,heading:"BTC Price Feed (Last 24 Hours)",changeLabel:"24h Change",highLabel:"24h High",lowLabel:"24h Low",emptyMessage:"No BTC price feed updates recorded in the past 4 hours."}],N=t=>{const r=Math.abs(t);return r>=1e3?{min:0,max:0}:r>=10?{min:2,max:2}:r>=1?{min:2,max:4}:r>=.01?{min:4,max:6}:{min:6,max:6}},v=t=>{if(t===null||Number.isNaN(t))return"—";const{min:r,max:s}=N(t);return`$${t.toLocaleString("en-US",{minimumFractionDigits:r,maximumFractionDigits:s})}`},X=t=>{const{min:r,max:s}=N(t);return`$${t.toLocaleString("en-US",{minimumFractionDigits:r,maximumFractionDigits:s})}`},V=t=>{const{max:r}=N(t);return`$${t.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:Math.max(0,r)})}`},L=(t,r)=>{if(t===null||r===null||Number.isNaN(t)||Number.isNaN(r))return"—";const s=t>0?"+":t<0?"−":"",a=Math.abs(t),{min:l,max:n}=N(a),i=Math.abs(r);return`${s}$${a.toLocaleString("en-US",{minimumFractionDigits:l,maximumFractionDigits:n})} (${s}${i.toFixed(2)}%)`},w=t=>t?new Date(t).toLocaleString([],{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"}):null,z=(t,r)=>{const s=new Date(t);return Number.isNaN(s.getTime())?"":r>=24*14?s.toLocaleDateString([],{month:"short",day:"numeric"}):r>=24?s.toLocaleString([],{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},b=({label:t,value:r,helper:s,accent:a})=>{const l=a==="positive"?"text-safe":a==="negative"?"text-critical":"text-foreground";return e.jsxs("div",{className:"p-4 rounded-xl bg-card/40 border border-border/40",children:[e.jsx("div",{className:"text-xs uppercase tracking-[0.08em] text-muted-foreground mb-1",children:t}),e.jsx("div",{className:k("text-2xl font-semibold",l),children:r}),s?e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:s}):null]})},J=({tab:t})=>{const{pricePoints:r,stats:s,isLoading:a,isFetching:l,error:n}=W({source:t.source,hours:t.hours,limit:t.limit}),i=r.map(o=>({time:z(o.timestamp,t.hours),price:o.price,blockNumber:o.blockNumber,timestamp:o.timestamp}));if(a&&r.length===0)return e.jsx(j,{value:t.value,className:"mt-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx("div",{className:"h-6 w-32 rounded bg-muted/20 animate-pulse"}),e.jsx("div",{className:"h-6 w-20 rounded bg-muted/20 animate-pulse"})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:Array.from({length:4}).map((o,m)=>e.jsx("div",{className:"h-20 bg-muted/20 animate-pulse rounded-xl"},m))}),e.jsx("div",{className:"h-64 bg-muted/20 animate-pulse rounded-xl"})]})});const d=s.change&&s.change!==0?s.change>0?"positive":"negative":void 0,c=s.change&&s.change!==0?s.change>0?M:$:null,h=w(s.lastUpdated);return e.jsxs(j,{value:t.value,className:"mt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[s.latestBlockNumber!==null&&e.jsxs(T,{variant:"outline",className:"border-primary/40 text-primary",children:["Block ",s.latestBlockNumber.toLocaleString()]}),n?null:l?e.jsx("span",{className:"animate-pulse",children:"Updating…"}):h?e.jsxs("span",{children:["Updated ",h]}):null]}),n?e.jsx(F,{variant:"destructive",className:"mt-4",children:e.jsxs(P,{children:["Unable to load price feed history: ",n.message]})}):null,e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mt-6",children:[e.jsx(b,{label:"Latest Price",value:v(s.latestPrice),helper:"Oracle price"}),e.jsx(b,{label:t.changeLabel,value:L(s.change,s.percentChange),helper:"Net move over the window",accent:d}),e.jsx(b,{label:t.highLabel,value:v(s.high),helper:"Peak oracle price"}),e.jsx(b,{label:t.lowLabel,value:v(s.low),helper:"Trough oracle price"})]}),e.jsxs("div",{className:"bg-card/40 rounded-xl p-4 mt-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-muted-foreground",children:"Oracle Price by Block"}),c?e.jsxs("div",{className:k("inline-flex items-center gap-1 text-xs font-medium",d==="positive"?"text-safe":"text-critical"),children:[e.jsx(c,{className:"h-4 w-4"}),L(s.change,s.percentChange)]}):null]}),n?null:i.length>0?e.jsx(H,{width:"100%",height:260,children:e.jsxs(R,{data:i,children:[e.jsx(E,{strokeDasharray:"3 3",stroke:"hsl(var(--border))",opacity:.3}),e.jsx(I,{dataKey:"time",stroke:"hsl(var(--muted-foreground))",tick:{fill:"hsl(var(--muted-foreground))"},tickLine:!1,minTickGap:20}),e.jsx(O,{stroke:"hsl(var(--muted-foreground))",tick:{fill:"hsl(var(--muted-foreground))"},tickLine:!1,domain:["auto","auto"],tickFormatter:V}),e.jsx(q,{contentStyle:{backgroundColor:"hsl(var(--card))",border:"1px solid hsl(var(--border))",borderRadius:"8px",color:"hsl(var(--foreground))"},labelFormatter:(o,m)=>{var g;const u=(g=m==null?void 0:m[0])==null?void 0:g.payload;if(!u)return"";const f=w(u.timestamp);return f?`${f} • Block ${u.blockNumber.toLocaleString()}`:""},formatter:o=>[X(o),"Price"]}),e.jsx(K,{type:"monotone",dataKey:"price",stroke:"hsl(var(--primary))",strokeWidth:2,dot:!1,activeDot:{r:5}})]})}):e.jsx("div",{className:"flex items-center justify-center h-52 text-sm text-muted-foreground",children:t.emptyMessage})]})]})},ne=()=>{const[t,r]=y.useState(p[0].value),s=p.find(a=>a.value===t)??p[0];return e.jsx(C,{className:"glass-card p-6",children:e.jsxs(U,{value:t,onValueChange:r,children:[e.jsxs("div",{className:"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-primary",children:[e.jsx(B,{className:"h-5 w-5"}),e.jsx("h2",{className:"text-lg font-semibold",children:s.heading})]}),e.jsx(_,{className:"order-last -mx-1 flex flex-nowrap items-center gap-2 overflow-x-auto bg-transparent p-0 lg:order-none lg:mx-0 lg:flex-wrap lg:bg-muted/10 lg:p-1",children:p.map(a=>e.jsx(A,{value:a.value,className:"flex-none whitespace-nowrap px-3 py-2 text-xs sm:text-sm",children:a.label},a.value))})]}),p.map(a=>e.jsx(J,{tab:a},a.value))]})})};export{ne as PriceFeedHistory};
