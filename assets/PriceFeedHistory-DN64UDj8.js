import{u as A,j as e}from"./query-CpGXJd7o.js";import{r as v}from"./react-uYZGv8Ap.js";import{s as M,C as B,b as E,A as H,a as $,h as _,B as R}from"./index-BsBz_Vj0.js";import{T as I,a as O,b as q,c as T}from"./tabs-D9FPYdxu.js";import{h as K,i as Y,b as G,c as z,d as Q}from"./lucide-BCdSs60Y.js";import{R as V,L as W,C as X,X as J,Y as Z,T as ee,a as te}from"./recharts-CblCIUsG.js";import"./supabase-CskpBK-R.js";const se=60*60*1e3,re=5e3,ae=async({source:t,hours:s,limit:r})=>{const n=new Date(Date.now()-s*se).toISOString(),{data:a,error:i}=await M.from("price_feeds").select("*").eq("source",t).gte("recorded_at",n).order("recorded_at",{ascending:!0}).limit(r??re);if(i)throw new Error(i.message);return a??[]},ie=({source:t,hours:s,limit:r})=>{const n=A({queryKey:["price-feed-history",t,s,r],queryFn:()=>ae({source:t,hours:s,limit:r}),refetchInterval:6e5,staleTime:3e4,refetchOnWindowFocus:!0,retry:1}),{points:a,stats:i}=v.useMemo(()=>{var g;const o=((g=n.data)==null?void 0:g.map(d=>({timestamp:d.recorded_at,blockNumber:d.block_number,price:d.price})))??[];if(o.length===0)return{points:o,stats:{latestPrice:null,change:null,percentChange:null,high:null,low:null,latestBlockNumber:null,lastUpdated:null}};const m=o[0],u=o[o.length-1],h=o.map(d=>d.price),j=Math.max(...h),c=Math.min(...h),f=u.price-m.price,w=m.price!==0?f/m.price*100:null;return{points:o,stats:{latestPrice:u.price,change:f,percentChange:w,high:j,low:c,latestBlockNumber:u.blockNumber,lastUpdated:u.timestamp}}},[n.data]);return{...n,pricePoints:a,stats:i}},P="mezo-chart-collapse-price-feed",p=[{value:"musd-1d",label:"MUSD feed · 24H",source:"musd_usdc",hours:24,limit:300,priceDivisor:1e5,heading:"MUSD / USDC 100k sell order (Last 24 Hours)",changeLabel:"24h Change",highLabel:"24h High",lowLabel:"24h Low",emptyMessage:"No price feed updates recorded in the last 24 hours."},{value:"musd-30d",label:"MUSD feed · 30D",source:"musd_usdc_4h",hours:24/4*30,limit:300,priceDivisor:1e5,heading:"MUSD / USDC 100k sell order (Last 30 Days)",changeLabel:"30d Change",highLabel:"30d High",lowLabel:"30d Low",emptyMessage:"No price feed updates recorded in the last 30 days."},{value:"btc",label:"BTC feed · 24H",source:"btc_oracle",hours:24,limit:300,heading:"BTC Price Feed (Last 24 Hours)",changeLabel:"24h Change",highLabel:"24h High",lowLabel:"24h Low",emptyMessage:"No BTC price feed updates recorded in the past 4 hours."}],N=t=>{const s=Math.abs(t);return s>=1e3?{min:0,max:0}:s>=10?{min:2,max:2}:s>=1?{min:2,max:4}:s>=.01?{min:4,max:6}:{min:6,max:6}},y=t=>{if(t===null||Number.isNaN(t))return"—";const{min:s,max:r}=N(t);return`$${t.toLocaleString("en-US",{minimumFractionDigits:s,maximumFractionDigits:r})}`},ne=t=>{const{min:s,max:r}=N(t);return`$${t.toLocaleString("en-US",{minimumFractionDigits:s,maximumFractionDigits:r})}`},oe=t=>{const{max:s}=N(t);return`$${t.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:Math.max(0,s)})}`},F=(t,s)=>{if(t===null||s===null||Number.isNaN(t)||Number.isNaN(s))return"—";const r=t>0?"+":t<0?"−":"",n=Math.abs(t),{min:a,max:i}=N(n),o=Math.abs(s);return`${r}$${n.toLocaleString("en-US",{minimumFractionDigits:a,maximumFractionDigits:i})} (${r}${o.toFixed(2)}%)`},U=t=>t?new Date(t).toLocaleString([],{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"}):null,le=(t,s)=>{const r=new Date(t);return Number.isNaN(r.getTime())?"":s>=24*14?r.toLocaleDateString([],{month:"short",day:"numeric"}):s>=24?r.toLocaleString([],{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):r.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},b=({label:t,value:s,helper:r,accent:n})=>{const a=n==="positive"?"text-safe":n==="negative"?"text-critical":"text-foreground";return e.jsxs("div",{className:"p-4 rounded-xl bg-card/40 border border-border/40",children:[e.jsx("div",{className:"text-xs uppercase tracking-[0.08em] text-muted-foreground mb-1",children:t}),e.jsx("div",{className:_("text-2xl font-semibold",a),children:s}),r?e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:r}):null]})},ce=({tab:t,isChartCollapsed:s,onToggleChart:r})=>{const{pricePoints:n,stats:a,isLoading:i,isFetching:o,error:m}=ie({source:t.source,hours:t.hours,limit:t.limit}),u=t.priceDivisor??1,h=l=>l===null?null:l/u,j=h(a.latestPrice),c=h(a.change),f=h(a.high),w=h(a.low),g=n.map(l=>({time:le(l.timestamp,t.hours),price:l.price/u,blockNumber:l.blockNumber,timestamp:l.timestamp}));if(i&&n.length===0)return e.jsx(T,{value:t.value,className:"mt-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx("div",{className:"h-6 w-32 rounded bg-muted/20 animate-pulse"}),e.jsx("div",{className:"h-6 w-20 rounded bg-muted/20 animate-pulse"})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:Array.from({length:4}).map((l,x)=>e.jsx("div",{className:"h-20 bg-muted/20 animate-pulse rounded-xl"},x))}),e.jsx("div",{className:"h-64 bg-muted/20 animate-pulse rounded-xl"})]})});const d=c&&c!==0?c>0?"positive":"negative":void 0,C=c&&c!==0?c>0?Y:G:null,D=U(a.lastUpdated);return e.jsxs(T,{value:t.value,className:"mt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[a.latestBlockNumber!==null&&e.jsxs(E,{variant:"outline",className:"border-primary/40 text-primary",children:["Block ",a.latestBlockNumber.toLocaleString()]}),m?null:o?e.jsx("span",{className:"animate-pulse",children:"Updating…"}):D?e.jsxs("span",{children:["Updated ",D]}):null]}),m?e.jsx(H,{variant:"destructive",className:"mt-4",children:e.jsxs($,{children:["Unable to load price feed history: ",m.message]})}):null,e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mt-6",children:[e.jsx(b,{label:"Latest Price",value:y(j),helper:"Oracle price"}),e.jsx(b,{label:t.changeLabel,value:F(c,a.percentChange),helper:"Net move over the window",accent:d}),e.jsx(b,{label:t.highLabel,value:y(f),helper:"Peak oracle price"}),e.jsx(b,{label:t.lowLabel,value:y(w),helper:"Trough oracle price"})]}),e.jsxs("div",{className:"bg-card/40 rounded-xl p-4 mt-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-muted-foreground",children:"Oracle Price by Block"}),e.jsxs("div",{className:"flex items-center gap-2",children:[C?e.jsxs("div",{className:_("inline-flex items-center gap-1 text-xs font-medium",d==="positive"?"text-safe":"text-critical"),children:[e.jsx(C,{className:"h-4 w-4"}),F(c,a.percentChange)]}):null,e.jsxs(R,{type:"button",variant:"ghost",size:"icon",className:"h-7 w-7",onClick:r,children:[s?e.jsx(z,{className:"h-4 w-4"}):e.jsx(Q,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:s?"Show chart":"Hide chart"})]})]})]}),s?e.jsx("div",{className:"text-xs text-muted-foreground",children:"Chart hidden."}):m?null:g.length>0?e.jsx(V,{width:"100%",height:260,children:e.jsxs(W,{data:g,children:[e.jsx(X,{strokeDasharray:"3 3",stroke:"hsl(var(--border))",opacity:.3}),e.jsx(J,{dataKey:"time",stroke:"hsl(var(--muted-foreground))",tick:{fill:"hsl(var(--muted-foreground))"},tickLine:!1,minTickGap:20}),e.jsx(Z,{stroke:"hsl(var(--muted-foreground))",tick:{fill:"hsl(var(--muted-foreground))"},tickLine:!1,domain:["auto","auto"],tickFormatter:oe}),e.jsx(ee,{contentStyle:{backgroundColor:"hsl(var(--card))",border:"1px solid hsl(var(--border))",borderRadius:"8px",color:"hsl(var(--foreground))"},labelFormatter:(l,x)=>{var k;const L=(k=x==null?void 0:x[0])==null?void 0:k.payload;if(!L)return"";const S=U(L.timestamp);return S?`${S} • Block ${L.blockNumber.toLocaleString()}`:""},formatter:l=>[ne(l),"Price"]}),e.jsx(te,{type:"monotone",dataKey:"price",stroke:"hsl(var(--primary))",strokeWidth:2,dot:!1,activeDot:{r:5}})]})}):e.jsx("div",{className:"flex items-center justify-center h-52 text-sm text-muted-foreground",children:t.emptyMessage})]})]})},fe=()=>{const[t,s]=v.useState(p[0].value),[r,n]=v.useState(()=>{if(typeof window>"u")return!1;try{return window.localStorage.getItem(P)==="true"}catch{return!1}}),a=p.find(i=>i.value===t)??p[0];return v.useEffect(()=>{try{window.localStorage.setItem(P,String(r))}catch{}},[r]),e.jsx(B,{className:"glass-card p-6",children:e.jsxs(I,{value:t,onValueChange:s,children:[e.jsxs("div",{className:"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-primary",children:[e.jsx(K,{className:"h-5 w-5"}),e.jsx("h2",{className:"text-lg font-semibold",children:a.heading})]}),e.jsx(O,{className:"order-last -mx-1 flex flex-nowrap items-center gap-2 overflow-x-auto bg-transparent p-0 lg:order-none lg:mx-0 lg:flex-wrap lg:bg-muted/10 lg:p-1",children:p.map(i=>e.jsx(q,{value:i.value,className:"flex-none whitespace-nowrap px-3 py-2 text-xs sm:text-sm",children:i.label},i.value))})]}),p.map(i=>e.jsx(ce,{tab:i,isChartCollapsed:r,onToggleChart:()=>n(o=>!o)},i.value))]})})};export{fe as PriceFeedHistory};
