import{u as F,j as e}from"./query-Df61bAsc.js";import{r as T}from"./react-uYZGv8Ap.js";import{s as U,C as M,B as _,A,a as B,c as P}from"./index-DevYselH.js";import{T as $,a as H,b as R,c as k}from"./tabs-DAesy6tt.js";import{e as E,f as I,d as O}from"./lucide-DPiKxmDp.js";import{R as q,L as K,C as Y,X as G,Y as Q,T as V,a as W}from"./recharts-wdVATIY2.js";import"./supabase-CskpBK-R.js";const X=60*60*1e3,z=5e3,J=async({source:t,hours:r,limit:s})=>{const a=new Date(Date.now()-r*X).toISOString(),{data:c,error:n}=await U.from("price_feeds").select("*").eq("source",t).gte("recorded_at",a).order("recorded_at",{ascending:!0}).limit(s??z);if(n)throw new Error(n.message);return c??[]},Z=({source:t,hours:r,limit:s})=>{const a=F({queryKey:["price-feed-history",t,r,s],queryFn:()=>J({source:t,hours:r,limit:s}),refetchInterval:6e5,staleTime:3e4,refetchOnWindowFocus:!0,retry:1}),{points:c,stats:n}=T.useMemo(()=>{var g;const i=((g=a.data)==null?void 0:g.map(d=>({timestamp:d.recorded_at,blockNumber:d.block_number,price:d.price})))??[];if(i.length===0)return{points:i,stats:{latestPrice:null,change:null,percentChange:null,high:null,low:null,latestBlockNumber:null,lastUpdated:null}};const m=i[0],u=i[i.length-1],o=i.map(d=>d.price),N=Math.max(...o),j=Math.min(...o),h=u.price-m.price,f=m.price!==0?h/m.price*100:null;return{points:i,stats:{latestPrice:u.price,change:h,percentChange:f,high:N,low:j,latestBlockNumber:u.blockNumber,lastUpdated:u.timestamp}}},[a.data]);return{...a,pricePoints:c,stats:n}},p=[{value:"musd-1d",label:"MUSD feed · 24H",source:"musd_usdc",hours:24,limit:300,priceDivisor:1e5,heading:"MUSD / USDC 100k sell order (Last 24 Hours)",changeLabel:"24h Change",highLabel:"24h High",lowLabel:"24h Low",emptyMessage:"No price feed updates recorded in the last 24 hours."},{value:"musd-30d",label:"MUSD feed · 30D",source:"musd_usdc_4h",hours:24/4*30,limit:300,priceDivisor:1e5,heading:"MUSD / USDC 100k sell order (Last 30 Days)",changeLabel:"30d Change",highLabel:"30d High",lowLabel:"30d Low",emptyMessage:"No price feed updates recorded in the last 30 days."},{value:"btc",label:"BTC feed · 24H",source:"btc_oracle",hours:24,limit:300,heading:"BTC Price Feed (Last 24 Hours)",changeLabel:"24h Change",highLabel:"24h High",lowLabel:"24h Low",emptyMessage:"No BTC price feed updates recorded in the past 4 hours."}],v=t=>{const r=Math.abs(t);return r>=1e3?{min:0,max:0}:r>=10?{min:2,max:2}:r>=1?{min:2,max:4}:r>=.01?{min:4,max:6}:{min:6,max:6}},w=t=>{if(t===null||Number.isNaN(t))return"—";const{min:r,max:s}=v(t);return`$${t.toLocaleString("en-US",{minimumFractionDigits:r,maximumFractionDigits:s})}`},ee=t=>{const{min:r,max:s}=v(t);return`$${t.toLocaleString("en-US",{minimumFractionDigits:r,maximumFractionDigits:s})}`},te=t=>{const{max:r}=v(t);return`$${t.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:Math.max(0,r)})}`},C=(t,r)=>{if(t===null||r===null||Number.isNaN(t)||Number.isNaN(r))return"—";const s=t>0?"+":t<0?"−":"",a=Math.abs(t),{min:c,max:n}=v(a),i=Math.abs(r);return`${s}$${a.toLocaleString("en-US",{minimumFractionDigits:c,maximumFractionDigits:n})} (${s}${i.toFixed(2)}%)`},S=t=>t?new Date(t).toLocaleString([],{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"}):null,se=(t,r)=>{const s=new Date(t);return Number.isNaN(s.getTime())?"":r>=24*14?s.toLocaleDateString([],{month:"short",day:"numeric"}):r>=24?s.toLocaleString([],{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},b=({label:t,value:r,helper:s,accent:a})=>{const c=a==="positive"?"text-safe":a==="negative"?"text-critical":"text-foreground";return e.jsxs("div",{className:"p-4 rounded-xl bg-card/40 border border-border/40",children:[e.jsx("div",{className:"text-xs uppercase tracking-[0.08em] text-muted-foreground mb-1",children:t}),e.jsx("div",{className:P("text-2xl font-semibold",c),children:r}),s?e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:s}):null]})},re=({tab:t})=>{const{pricePoints:r,stats:s,isLoading:a,isFetching:c,error:n}=Z({source:t.source,hours:t.hours,limit:t.limit}),i=t.priceDivisor??1,m=l=>l===null?null:l/i,u=m(s.latestPrice),o=m(s.change),N=m(s.high),j=m(s.low),h=r.map(l=>({time:se(l.timestamp,t.hours),price:l.price/i,blockNumber:l.blockNumber,timestamp:l.timestamp}));if(a&&r.length===0)return e.jsx(k,{value:t.value,className:"mt-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx("div",{className:"h-6 w-32 rounded bg-muted/20 animate-pulse"}),e.jsx("div",{className:"h-6 w-20 rounded bg-muted/20 animate-pulse"})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:Array.from({length:4}).map((l,x)=>e.jsx("div",{className:"h-20 bg-muted/20 animate-pulse rounded-xl"},x))}),e.jsx("div",{className:"h-64 bg-muted/20 animate-pulse rounded-xl"})]})});const f=o&&o!==0?o>0?"positive":"negative":void 0,g=o&&o!==0?o>0?I:O:null,d=S(s.lastUpdated);return e.jsxs(k,{value:t.value,className:"mt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[s.latestBlockNumber!==null&&e.jsxs(_,{variant:"outline",className:"border-primary/40 text-primary",children:["Block ",s.latestBlockNumber.toLocaleString()]}),n?null:c?e.jsx("span",{className:"animate-pulse",children:"Updating…"}):d?e.jsxs("span",{children:["Updated ",d]}):null]}),n?e.jsx(A,{variant:"destructive",className:"mt-4",children:e.jsxs(B,{children:["Unable to load price feed history: ",n.message]})}):null,e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mt-6",children:[e.jsx(b,{label:"Latest Price",value:w(u),helper:"Oracle price"}),e.jsx(b,{label:t.changeLabel,value:C(o,s.percentChange),helper:"Net move over the window",accent:f}),e.jsx(b,{label:t.highLabel,value:w(N),helper:"Peak oracle price"}),e.jsx(b,{label:t.lowLabel,value:w(j),helper:"Trough oracle price"})]}),e.jsxs("div",{className:"bg-card/40 rounded-xl p-4 mt-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-muted-foreground",children:"Oracle Price by Block"}),g?e.jsxs("div",{className:P("inline-flex items-center gap-1 text-xs font-medium",f==="positive"?"text-safe":"text-critical"),children:[e.jsx(g,{className:"h-4 w-4"}),C(o,s.percentChange)]}):null]}),n?null:h.length>0?e.jsx(q,{width:"100%",height:260,children:e.jsxs(K,{data:h,children:[e.jsx(Y,{strokeDasharray:"3 3",stroke:"hsl(var(--border))",opacity:.3}),e.jsx(G,{dataKey:"time",stroke:"hsl(var(--muted-foreground))",tick:{fill:"hsl(var(--muted-foreground))"},tickLine:!1,minTickGap:20}),e.jsx(Q,{stroke:"hsl(var(--muted-foreground))",tick:{fill:"hsl(var(--muted-foreground))"},tickLine:!1,domain:["auto","auto"],tickFormatter:te}),e.jsx(V,{contentStyle:{backgroundColor:"hsl(var(--card))",border:"1px solid hsl(var(--border))",borderRadius:"8px",color:"hsl(var(--foreground))"},labelFormatter:(l,x)=>{var D;const L=(D=x==null?void 0:x[0])==null?void 0:D.payload;if(!L)return"";const y=S(L.timestamp);return y?`${y} • Block ${L.blockNumber.toLocaleString()}`:""},formatter:l=>[ee(l),"Price"]}),e.jsx(W,{type:"monotone",dataKey:"price",stroke:"hsl(var(--primary))",strokeWidth:2,dot:!1,activeDot:{r:5}})]})}):e.jsx("div",{className:"flex items-center justify-center h-52 text-sm text-muted-foreground",children:t.emptyMessage})]})]})},de=()=>{const[t,r]=T.useState(p[0].value),s=p.find(a=>a.value===t)??p[0];return e.jsx(M,{className:"glass-card p-6",children:e.jsxs($,{value:t,onValueChange:r,children:[e.jsxs("div",{className:"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-primary",children:[e.jsx(E,{className:"h-5 w-5"}),e.jsx("h2",{className:"text-lg font-semibold",children:s.heading})]}),e.jsx(H,{className:"order-last -mx-1 flex flex-nowrap items-center gap-2 overflow-x-auto bg-transparent p-0 lg:order-none lg:mx-0 lg:flex-wrap lg:bg-muted/10 lg:p-1",children:p.map(a=>e.jsx(R,{value:a.value,className:"flex-none whitespace-nowrap px-3 py-2 text-xs sm:text-sm",children:a.label},a.value))})]}),p.map(a=>e.jsx(re,{tab:a},a.value))]})})};export{de as PriceFeedHistory};
